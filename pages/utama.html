<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Mari Aktif - Platform Interaktif Kompetisi">
    <meta name="theme-color" content="#2777b9">
    <title>Mari Aktif - Navigation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/public/utama.css">
    <link rel="stylesheet" href="/public/responsive.css">
    <link rel="stylesheet" href="/public/responsive-animations.css">
    <script src="/public/avatarUtils.js"></script>
</head>
<body>
    <komponen navbar></komponen>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Sidebar Profile -->
        <aside class="sidebar">
            <div class="profile-card">
                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar" style="font-size: 36px; font-weight: 600;">
                        R
                    </div>
                </div>
                <div class="profile-body">
                    <div class="profile-name" id="userName"></div>
                    <div class="profile-title" id="userNisn"></div>
                    <div class="profile-stats">
                        <div class="stat">
                            <div class="stat-label">Koneksi</div>
                            <div class="stat-value"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-title">
                    <i class="fas fa-bookmark"></i> Item yang disimpan
                </div>
                <div id="savedItemsList" style="display: flex; flex-direction: column; gap: 8px;">
                    <!-- Saved items akan ditampilkan di sini -->
                </div>
            </div>
        </aside>

        <!-- Feed -->
        <main class="feed">
            <!-- Post Creator -->
            <div class="post-creator">
                <div class="post-input-area">
                    <div class="post-avatar" id="postCreatorAvatar" style="font-size: 20px; font-weight: 600;">
                        R
                    </div>
                    <div class="post-input-wrapper">
                        <input type="text" class="post-input" placeholder="Mulai buat posting" id="postInputTrigger" readonly style="cursor: pointer;">
                    </div>
                </div>
                <div class="post-actions">
                </div>
            </div>

            <!-- Posts Container - akan diisi oleh JavaScript -->
            <div id="postsContainer"></div>
        </main>
    </div>

    <!-- Create Post Modal -->
    <div class="modal" id="postModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Buat Postingan</h2>
                <button class="modal-close" onclick="closePostModal()">Ã—</button>
            </div>
            <div class="form-group">
                <label class="form-label">Apa yang ingin Anda bagikan?</label>
                <div style="position: relative;">
                    <textarea class="form-input" id="postContent" rows="4" placeholder="Tulis sesuatu..."></textarea>
                </div>
            </div>
            <button class="btn-primary" onclick="createPost()">Posting</button>
        </div>
    </div>

    <script src="/public/topNavigasi.js"></script>
    <script src="/public/responsive-scaler.js"></script>
    <script src="/public/categoryConfig.js"></script>
    <script src="/public/search.js"></script>
    <script src="/public/protected-page.js"></script>
    <script src="/public/avatarUtils.js"></script>
    <script src="/public/postingSystem.js"></script>
    
    <script>
        // Load saved competitions dari server (per user)
        async function loadSavedItems() {
            const token = localStorage.getItem('authToken');
            
            if (!token) {
                document.getElementById('savedItemsList').innerHTML = '<p style="color: #999; font-size: 13px; padding: 10px 0;">Silakan login untuk melihat item yang disimpan</p>';
                return;
            }
            
            try {
                const response = await fetch('/api/user/saved-competitions', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                const container = document.getElementById('savedItemsList');
                
                if (!data.success || !data.savedCompetitions || data.savedCompetitions.length === 0) {
                    container.innerHTML = '<p style="color: #999; font-size: 13px; padding: 10px 0;">Belum ada item yang disimpan</p>';
                    return;
                }
                
                // Fetch competition details untuk logo dan warna
                const response2 = await fetch('/api/lowongan');
                const data2 = await response2.json();
                const competitionsMap = {};
                
                if (data2.success && data2.lowongan) {
                    data2.lowongan.forEach(comp => {
                        competitionsMap[comp._id] = comp;
                    });
                }
                
                container.innerHTML = data.savedCompetitions.map((item) => {
                    const comp = competitionsMap[item.id];
                    
                    // Get category config for dynamic icon and color
                    let config = { color: '#6b7280', icon: 'fas fa-star' };
                    if (comp && typeof getCategoryConfig === 'function') {
                        const filterKey = normalizeCategoryToFilter(comp.kategori);
                        config = getCategoryConfig(filterKey);
                    }
                    
                    return `
                        <a href="/lowongan?id=${item.id}" class="sidebar-link" title="${item.title}" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-decoration: none; background: #ffffff; border: 1px solid #e0e0e0; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
                            <div style="width: 56px; height: 56px; min-width: 56px; border-radius: 12px; display: flex; align-items: center; justify-content: center; background: ${config.color}; color: white; flex-shrink: 0; line-height: 1;">
                                <i class="${config.icon}" style="font-size: 28px; color: white; display: flex; align-items: center; justify-content: center;"></i>
                            </div>
                            <div style="flex: 1; overflow: hidden;">
                                <div style="font-size: 14px; font-weight: 600; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.title}</div>
                                <div style="font-size: 12px; color: #999; margin-top: 2px;">${comp?.kategori || 'Kategori'}</div>
                            </div>
                        </a>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading saved items:', error);
                document.getElementById('savedItemsList').innerHTML = '<p style="color: #999; font-size: 13px; padding: 10px 0;">Error memuat item yang disimpan</p>';
            }
        }
        
        // Update saved items
        function updateSavedItems() {
            loadSavedItems();
        }
        
        // Load saat halaman buka
        document.addEventListener('DOMContentLoaded', loadSavedItems);
    </script>
    
    <script>
        // Function untuk update avatar
        function updateAvatarDisplay(userName) {
            if (!userName || userName === 'User') return;
            
            // Update profile avatar
            const profileAvatar = document.getElementById('profileAvatar');
            if (profileAvatar) {
                const initials = getInitials(userName);
                const color = getAvatarColor(userName);
                profileAvatar.textContent = initials;
                profileAvatar.style.backgroundColor = color;
            }
            
            // Update profile header background dengan warna yang sama
            const profileHeader = document.querySelector('.profile-header');
            if (profileHeader) {
                const color = getAvatarColor(userName);
                profileHeader.style.background = `linear-gradient(135deg, ${color} 0%, ${color} 100%)`;
            }
            
            // Update post creator avatar
            const postCreatorAvatar = document.getElementById('postCreatorAvatar');
            if (postCreatorAvatar) {
                const initials = getInitials(userName);
                const color = getAvatarColor(userName);
                postCreatorAvatar.textContent = initials;
                postCreatorAvatar.style.backgroundColor = color;
            }
        }
        
        // Initialize avatar dengan inisial
        document.addEventListener('DOMContentLoaded', function() {
            // Coba ambil dari localStorage terlebih dahulu, fallback ke HTML element
            let userName = 'User';
            
            try {
                const currentUser = localStorage.getItem('currentUser');
                if (currentUser) {
                    const user = JSON.parse(currentUser);
                    userName = user.username || 'User';
                }
            } catch (e) {
                // Fallback ke HTML element jika localStorage error
                userName = document.getElementById('userName').textContent || 'User';
            }
            
            // Jika masih default, ambil dari HTML element
            if (userName === 'User') {
                userName = document.getElementById('userName').textContent || 'User';
            }
            
            updateAvatarDisplay(userName);
            
            // Observer untuk mendengarkan perubahan pada userName element
            const userNameElement = document.getElementById('userName');
            if (userNameElement) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList' || mutation.type === 'characterData') {
                            const newUserName = userNameElement.textContent;
                            if (newUserName && newUserName !== 'Rayhan Nurindra') { // Ignore default value
                                updateAvatarDisplay(newUserName);
                            }
                        }
                    });
                });
                
                observer.observe(userNameElement, {
                    childList: true,
                    subtree: true,
                    characterData: true
                });
            }
        });
    </script>
    
    <script src="/public/notification.js"></script>
</body>
</html>